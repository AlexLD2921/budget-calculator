<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>UK Pay & Budget Dashboard | apeX CX</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<style>
:root{
  --ink:#0f172a;--ink2:#334155;--ink3:#64748b;--ink4:#94a3b8;
  --paper:#f8fafc;--card:#ffffff;--border:#e2e8f0;
  --indigo:#6366f1;--indigo-d:#4f46e5;--indigo-l:#eef2ff;--indigo-m:#c7d2fe;
  --amber:#f59e0b;--amber-d:#d97706;--amber-l:#fffbeb;--amber-m:#fde68a;
  --green:#16a34a;--green-l:#f0fdf4;--green-m:#86efac;
  --red:#dc2626;--red-l:#fef2f2;--red-m:#fca5a5;
  --radius:12px;--radius-sm:8px;--radius-xs:6px;
  --shadow:0 1px 3px rgba(0,0,0,.08),0 1px 2px rgba(0,0,0,.05);
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'DM Sans',sans-serif;background:var(--paper);color:var(--ink);font-size:14px;line-height:1.5}
input,select,button,textarea{font-family:inherit}
button{cursor:pointer}button:disabled{cursor:not-allowed;opacity:.5}
.mono{font-family:'DM Mono',monospace}
.app-shell{min-height:100vh;display:flex;flex-direction:column}
.top-bar{background:var(--ink);color:#fff;padding:0 24px;display:flex;align-items:center;gap:16px;height:56px;position:sticky;top:0;z-index:100}
.top-bar h1{font-size:15px;font-weight:600}
.top-bar span{font-size:11px;color:#94a3b8;margin-left:4px}
.tab-bar{background:var(--card);border-bottom:1px solid var(--border);padding:0 24px;display:flex;position:sticky;top:56px;z-index:99}
.tab-btn{padding:14px 20px;font-size:13px;font-weight:500;border:none;background:none;color:var(--ink3);border-bottom:2px solid transparent;cursor:pointer;display:flex;align-items:center;gap:6px}
.tab-btn.active{color:var(--indigo);border-bottom-color:var(--indigo);font-weight:600}
.main{padding:24px;max-width:1100px;margin:0 auto;width:100%;flex:1}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow);margin-bottom:12px}
.card-title{font-size:15px;font-weight:600;margin-bottom:16px}
.btn{display:inline-flex;align-items:center;gap:6px;padding:9px 16px;border-radius:var(--radius-sm);font-size:13px;font-weight:600;border:none;cursor:pointer;white-space:nowrap}
.btn-primary{background:var(--indigo);color:#fff}.btn-primary:hover{background:var(--indigo-d)}
.btn-amber{background:var(--amber);color:#fff}.btn-amber:hover{background:var(--amber-d)}
.btn-outline{background:var(--card);border:1px solid var(--border);color:var(--ink2)}
.btn-ghost{background:none;border:none;color:var(--ink3);padding:6px 10px;cursor:pointer}
.btn-danger{background:var(--red-l);border:1px solid var(--red-m);color:var(--red);padding:6px 10px;cursor:pointer;font-size:12px;border-radius:var(--radius-xs)}
.btn-sm{padding:6px 12px;font-size:12px}
.btn-lg{padding:13px 24px;font-size:15px}
.btn-block{width:100%;justify-content:center}
.field{margin-bottom:12px}
.field label{display:block;font-size:11px;font-weight:600;color:var(--ink3);margin-bottom:5px;text-transform:uppercase;letter-spacing:.04em}
.input{width:100%;padding:9px 11px;border:1px solid var(--border);border-radius:var(--radius-xs);font-size:14px;background:var(--card);color:var(--ink)}
.input:focus{outline:none;border-color:var(--indigo);box-shadow:0 0 0 3px rgba(99,102,241,.1)}
.input-wrap{position:relative}
.input-wrap .pfx{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--ink4);pointer-events:none;font-size:13px}
.input-wrap .input{padding-left:24px}
.select{width:100%;padding:9px 11px;border:1px solid var(--border);border-radius:var(--radius-xs);font-size:14px;background:var(--card);color:var(--ink);cursor:pointer}
.select:focus{outline:none;border-color:var(--indigo)}
.grid{display:grid;gap:12px}
.g2{grid-template-columns:1fr 1fr}
.g3{grid-template-columns:1fr 1fr 1fr}
.g4{grid-template-columns:1fr 1fr 1fr 1fr}
.stat-box{border-radius:var(--radius);padding:16px 20px;border:1px solid}
.stat-green{background:var(--green-l);border-color:var(--green-m);color:var(--green)}
.stat-red{background:var(--red-l);border-color:var(--red-m);color:var(--red)}
.stat-blue{background:var(--indigo-l);border-color:var(--indigo-m);color:var(--indigo-d)}
.stat-label{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.04em;opacity:.8;margin-bottom:4px}
.stat-val{font-size:22px;font-weight:700;line-height:1.1;font-family:'DM Mono',monospace}
.stat-sub{font-size:11px;opacity:.7;margin-top:3px}
.wizard-wrap{max-width:520px;margin:0 auto}
.wpips{display:flex;gap:4px;margin-bottom:24px}
.wpip{flex:1;height:3px;border-radius:2px;background:var(--border)}
.wpip.done{background:var(--indigo)}
.wpip.done-a{background:var(--amber)}
.wlabel{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--ink4);margin-bottom:10px}
.wtitle{font-size:20px;font-weight:700;margin-bottom:20px;color:var(--ink)}
.wnav{display:flex;gap:8px;margin-top:24px}
.choice-grid{display:grid;gap:8px}
.cbtn{padding:12px 16px;border-radius:var(--radius-sm);border:1.5px solid var(--border);background:var(--card);text-align:left;font-size:14px;font-weight:500;color:var(--ink2);cursor:pointer}
.cbtn.sel-b{border-color:var(--indigo);background:var(--indigo-l);color:var(--indigo-d);font-weight:600}
.cbtn.sel-a{border-color:var(--amber);background:var(--amber-l);color:var(--amber-d);font-weight:600}
.data-table{width:100%;border-collapse:collapse}
.data-table th{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--ink4);padding:8px 12px;border-bottom:1px solid var(--border);text-align:left;white-space:nowrap}
.data-table td{padding:10px 12px;border-bottom:1px solid #f1f5f9;font-size:13px;vertical-align:middle}
.data-table tr:last-child td{border-bottom:none}
.alert{padding:12px 14px;border-radius:var(--radius-sm);font-size:13px;margin-bottom:8px}
.alert-warn{background:#fffbeb;border:1px solid #fde68a;color:#92400e}
.alert-info{background:var(--indigo-l);border:1px solid var(--indigo-m);color:var(--indigo-d)}
.alert-danger{background:var(--red-l);border:1px solid var(--red-m);color:var(--red)}
.upload-zone{border:2px dashed var(--border);border-radius:var(--radius);padding:32px;text-align:center;cursor:pointer}
.upload-zone:hover{border-color:var(--indigo);background:var(--indigo-l)}
.prog-bar{height:8px;background:var(--border);border-radius:99px;overflow:hidden}
.prog-fill{height:100%;border-radius:99px}
.section-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.section-hdr h3{font-size:16px;font-weight:700}
.tag{font-size:10px;padding:2px 7px;border-radius:99px;font-weight:600}
.tag-blue{background:var(--indigo-l);color:var(--indigo-d)}
.tag-amber{background:var(--amber-l);color:var(--amber-d)}
.tag-gray{background:var(--paper);color:var(--ink3);border:1px solid var(--border)}
.event-row{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;border-radius:var(--radius-sm);margin-bottom:5px;font-size:13px}
.event-inc{background:#f0fdf4}
.event-out{background:#fef2f2}
.eamt{font-weight:700;font-family:'DM Mono',monospace;font-size:12px}
.event-inc .eamt{color:var(--green)}
.event-out .eamt{color:var(--red)}
.month-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:12px;overflow:hidden}
.month-hdr{padding:14px 20px;background:var(--paper);border-bottom:1px solid var(--border);font-weight:600;font-size:14px;display:flex;justify-content:space-between;align-items:center}
.month-body{padding:16px 20px}
@media(max-width:640px){.main{padding:16px}.g2,.g3,.g4{grid-template-columns:1fr}.tab-btn .lbl{display:none}}
@keyframes fi{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
.fi{animation:fi .2s ease forwards}
</style>
</head>
<body>
<div id="root"><div style="display:flex;align-items:center;justify-content:center;height:100vh;font-family:sans-serif;color:#64748b;font-size:14px">Loadingâ€¦</div></div>

<script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin></script>

<script>
'use strict';
const e=React.createElement;
const {useState,useEffect,useMemo,useRef}=React;

// â”€â”€ CONSTANTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const BH=new Set(["2024-01-01","2024-03-29","2024-04-01","2024-05-06","2024-05-27","2024-08-26","2024-12-25","2024-12-26","2025-01-01","2025-04-18","2025-04-21","2025-05-05","2025-05-26","2025-08-25","2025-12-25","2025-12-26","2026-01-01","2026-04-03","2026-04-06","2026-05-04","2026-05-25","2026-08-31","2026-12-25","2026-12-28"]);
const isWD=d=>{const w=d.getDay();return w!==0&&w!==6&&!BH.has(d.toISOString().slice(0,10))};
const lastWD=(y,m)=>{let d=new Date(y,m+1,0);while(!isWD(d))d.setDate(d.getDate()-1);return new Date(d)};
const firstWD=(y,m)=>{let d=new Date(y,m,1);while(!isWD(d))d.setDate(d.getDate()+1);return new Date(d)};
const resDate=(r,y,m)=>{
  if(!r)return null;
  if(r==="last")return lastWD(y,m);
  if(r==="first")return firstWD(y,m);
  const n=parseInt(r);
  if(!isNaN(n)){let d=new Date(y,m,n);if(d.getMonth()!==m)d=new Date(y,m+1,0);while(!isWD(d))d.setDate(d.getDate()-1);return new Date(d)}
  return null;
};
const isBH=d=>BH.has(d.toISOString().slice(0,10));
const isWeekend=d=>{const w=d.getDay();return w===0||w===6};
const dateWarning=d=>{if(!d)return null;if(isBH(d))return"Bank holiday";if(isWeekend(d))return"Weekend";return null};
const gbp=n=>new Intl.NumberFormat("en-GB",{style:"currency",currency:"GBP",maximumFractionDigits:0}).format(n||0);
const fmtD=d=>d?new Date(d).toLocaleDateString("en-GB",{day:"numeric",month:"short"}):"â€”";

const CATS=["Housing","Car","Insurance","Media","Dog","Loans","Kids","Health","Savings","Short Term Payment","Food","Petrol","Schools","Misc"];
const CAT_COLORS={"Housing":"#6366f1","Car":"#f59e0b","Insurance":"#0d9488","Media":"#8b5cf6","Dog":"#f97316","Loans":"#ef4444","Kids":"#ec4899","Health":"#14b8a6","Savings":"#22c55e","Short Term Payment":"#64748b","Food":"#84cc16","Petrol":"#06b6d4","Schools":"#a855f7","Misc":"#94a3b8"};
const ACCOUNTS=["Starling","Nationwide","Other"];
const SL={plan1:{t:24990,r:0.09},plan2:{t:27295,r:0.09},plan4:{t:31395,r:0.09},plan5:{t:25000,r:0.09},postgrad:{t:21000,r:0.06}};
const INC_CATS=["Salary","Freelance","Rental","Benefits","Investment","Other"];

const ls={
  get:k=>{try{return JSON.parse(localStorage.getItem(k))}catch{return null}},
  set:(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v))}catch{}}
};

// â”€â”€ TAX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const calcTax=g=>{if(g<=12570)return 0;const ti=g-12570;if(g<=50270)return ti*.20;if(g<=125140)return(50270-12570)*.20+(g-50270)*.40;return(50270-12570)*.20+(125140-50270)*.40+(g-125140)*.45};
const calcNI=g=>{if(g<=12570)return 0;if(g<=50270)return(g-12570)*.08;return(50270-12570)*.08+(g-50270)*.02};
function calcP(p){
  const base=parseFloat(p.grossSalary)||0,bonus=parseFloat(p.bonus)||0;
  const bens=(parseFloat(p.carBenefit)||0)+(parseFloat(p.medicalBenefit)||0)+(parseFloat(p.otherBenefits)||0);
  const gross=base+bonus+bens;
  const pen=base*(parseFloat(p.pensionPercent)||0)/100;
  const ePen=base*(parseFloat(p.employerPensionPercent)||0)/100;
  const cc=parseFloat(p.childcare)||0,cy=parseFloat(p.cyclescheme)||0;
  const taxable=gross-pen-cc-cy;
  const tax=calcTax(taxable),ni=calcNI(taxable);
  let sl=0;
  if(p.studentLoan&&p.studentLoan!=="none"&&SL[p.studentLoan]){const{t,r}=SL[p.studentLoan];if(gross>t)sl=(gross-t)*r}
  const net=gross-tax-ni-pen-cc-cy-sl;
  return{gross,tax,ni,pen,ePen,totalPen:pen+ePen,sl,net,netM:net/12,netW:net/52};
}
const emptyP=()=>({grossSalary:"",bonus:"",carBenefit:"",medicalBenefit:"",otherBenefits:"",pensionPercent:"",employerPensionPercent:"",studentLoan:"none",childcare:"",cyclescheme:""});

// â”€â”€ CSV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseStarlingCSV(text){
  const lines=text.trim().split("\n"),rows=[];
  for(let i=1;i<lines.length;i++){
    const cols=lines[i].split(",").map(c=>c.replace(/^"|"$/g,"").trim());
    if(cols.length<4)continue;
    const [date,,ref,type,,,,amtStr]=cols;
    const amount=parseFloat((amtStr||"").replace(/[^-\d.]/g,""))||0;
    if(amount<0)rows.push({date,description:ref||type,amount:Math.abs(amount)});
  }
  return rows;
}
function parseNationwideCSV(text){
  const lines=text.trim().split("\n"),rows=[];
  let started=false;
  for(const line of lines){
    if(!started){if(line.toLowerCase().includes("date"))started=true;continue}
    const cols=line.split(",").map(c=>c.replace(/^"|"$/g,"").trim());
    if(cols.length<4)continue;
    const [date,desc,,outStr]=cols;
    const amount=parseFloat((outStr||"").replace(/[^-\d.]/g,""))||0;
    if(amount>0)rows.push({date,description:desc,amount});
  }
  return rows;
}
function guessCat(desc){
  const d=(desc||"").toLowerCase();
  if(/mortgage|rent|council|water|electric|gas|broadband|edf|british gas|eon|severn|thames|sky broadband|virgin media/.test(d))return"Housing";
  if(/fuel|petrol|shell|bp |texaco|esso/.test(d))return"Petrol";
  if(/tesco|sainsbury|asda|morrisons|waitrose|co-op|lidl|aldi|m&s food/.test(d))return"Food";
  if(/netflix|spotify|amazon prime|disney|youtube|apple tv|now tv|sky|bt sport/.test(d))return"Media";
  if(/school|nursery|childminder/.test(d))return"Schools";
  if(/insurance|aviva|admiral|direct line|hastings/.test(d))return"Insurance";
  if(/loan|finance|credit|barclaycard/.test(d))return"Loans";
  if(/gym|fitness|health|dental|boots|specsavers/.test(d))return"Health";
  if(/savings|save|pot|isa/.test(d))return"Savings";
  if(/car|mot|halfords|kwikfit|parking|dvla/.test(d))return"Car";
  if(/vet|pet|dog|pets at home/.test(d))return"Dog";
  return"Misc";
}

// â”€â”€ SVG CHARTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function DonutChart({data}){
  const[hov,setHov]=useState(null);
  const total=data.reduce((s,d)=>s+d.value,0);
  if(!total)return e('div',{style:{height:"200px",display:"flex",alignItems:"center",justifyContent:"center",color:"var(--ink4)",fontSize:"13px"}},"No data yet");
  const size=200,cx=100,cy=100,ro=85,ri=50;
  let angle=-Math.PI/2;
  const slices=data.map((d,i)=>{
    const sweep=(d.value/total)*2*Math.PI;
    const a1=angle,a2=angle+sweep;
    angle=a2;
    const x1=cx+ro*Math.cos(a1),y1=cy+ro*Math.sin(a1);
    const x2=cx+ro*Math.cos(a2),y2=cy+ro*Math.sin(a2);
    const ix1=cx+ri*Math.cos(a1),iy1=cy+ri*Math.sin(a1);
    const ix2=cx+ri*Math.cos(a2),iy2=cy+ri*Math.sin(a2);
    const lg=sweep>Math.PI?1:0;
    const path=`M${ix1},${iy1} L${x1},${y1} A${ro},${ro} 0 ${lg},1 ${x2},${y2} L${ix2},${iy2} A${ri},${ri} 0 ${lg},0 ${ix1},${iy1}Z`;
    return e('path',{key:i,d:path,fill:d.color,opacity:hov===null||hov===i?1:0.4,style:{cursor:"pointer",transition:"opacity .15s"},onMouseEnter:()=>setHov(i),onMouseLeave:()=>setHov(null)});
  });
  const hd=hov!==null?data[hov]:null;
  return e('svg',{width:size,height:size,viewBox:`0 0 ${size} ${size}`,style:{display:"block",margin:"0 auto"}},
    ...slices,
    e('text',{x:cx,y:cy-8,textAnchor:"middle",style:{fontSize:"11px",fill:"var(--ink4)",fontFamily:"sans-serif"}},hd?hd.name:"Total"),
    e('text',{x:cx,y:cy+12,textAnchor:"middle",style:{fontSize:"15px",fontWeight:"700",fill:"var(--ink)",fontFamily:"monospace"}},hd?gbp(hd.value):gbp(total))
  );
}

function BarChartSVG({data}){
  const W=400,H=180,pl=48,pb=28,pr=8,pt=8;
  const iW=W-pl-pr,iH=H-pt-pb;
  const maxV=Math.max(...data.flatMap(d=>[d.income,d.outgoings,d.surplus]),1);
  const bConf=[{k:"income",c:"#86efac",l:"Income"},{k:"outgoings",c:"#fca5a5",l:"Outgoings"},{k:"surplus",c:"#c7d2fe",l:"Surplus"}];
  const gW=Math.floor(iW/data.length);
  const bW=Math.floor((gW-6)/3);
  return e('svg',{width:"100%",viewBox:`0 0 ${W} ${H}`,style:{display:"block"}},
    ...[0,0.25,0.5,0.75,1].map((f,i)=>{
      const v=Math.round(maxV*f),y=pt+iH-f*iH;
      return e('g',{key:i},
        e('line',{x1:pl,x2:pl+iW,y1:y,y2:y,stroke:"#e2e8f0",strokeWidth:1}),
        e('text',{x:pl-5,y:y+4,textAnchor:"end",style:{fontSize:"9px",fill:"#94a3b8",fontFamily:"monospace"}},v>=1000?"Â£"+Math.round(v/1000)+"k":"Â£"+v)
      );
    }),
    ...data.map((d,gi)=>{
      const gx=pl+gi*gW+3;
      return e('g',{key:gi},
        ...bConf.map((b,bi)=>{
          const h=Math.max(2,(d[b.k]/maxV)*iH);
          return e('rect',{key:bi,x:gx+bi*bW,y:pt+iH-h,width:bW-2,height:h,fill:b.c,rx:2});
        }),
        e('text',{x:gx+gW/2-3,y:H-pb+14,textAnchor:"middle",style:{fontSize:"9px",fill:"#64748b",fontFamily:"sans-serif"}},d.name)
      );
    }),
    ...bConf.map((b,i)=>e('g',{key:i,transform:`translate(${pl+i*90},${H-2})`},
      e('rect',{x:0,y:-8,width:8,height:8,fill:b.c,rx:1}),
      e('text',{x:11,y:0,style:{fontSize:"9px",fill:"#64748b",fontFamily:"sans-serif"}},b.l)
    ))
  );
}

// â”€â”€ APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function App(){
  const[tab,setTab]=useState("calc");
  const[incomes,setIncomes]=useState(()=>ls.get("apex_inc")||[]);
  const[outgoings,setOutgoings]=useState(()=>ls.get("apex_out")||[]);
  const[statements,setStatements]=useState(()=>ls.get("apex_stmt")||[]);
  useEffect(()=>ls.set("apex_inc",incomes),[incomes]);
  useEffect(()=>ls.set("apex_out",outgoings),[outgoings]);
  useEffect(()=>ls.set("apex_stmt",statements),[statements]);

  const useInBudget=(p1,p2)=>{
    const ni=[{id:Date.now(),name:"Salary (Person 1)",amount:Math.round(p1),isNet:true,category:"Salary",dateRule:"last"}];
    if(p2)ni.push({id:Date.now()+1,name:"Salary (Person 2)",amount:Math.round(p2),isNet:true,category:"Salary",dateRule:"last"});
    setIncomes(ni);setTab("budget");
  };

  return e('div',{className:"app-shell"},
    e('div',{className:"top-bar"},
      e('svg',{width:24,height:24,viewBox:"0 0 24 24",fill:"none"},
        e('rect',{x:2,y:2,width:9,height:9,rx:2,fill:"#6366f1"}),
        e('rect',{x:13,y:2,width:9,height:9,rx:2,fill:"#f59e0b"}),
        e('rect',{x:2,y:13,width:9,height:9,rx:2,fill:"#0d9488"}),
        e('rect',{x:13,y:13,width:9,height:9,rx:2,fill:"#fff",opacity:".3"})
      ),
      e('h1',null,"apeX Pay & Budget ",e('span',null,"2024/25"))
    ),
    e('div',{className:"tab-bar"},
      ...[["calc","ðŸ’°","Pay Calculator"],["budget","ðŸ“‹","Budget Setup"],["dashboard","ðŸ“Š","Dashboard"]].map(([id,icon,label])=>
        e('button',{key:id,className:"tab-btn"+(tab===id?" active":""),onClick:()=>setTab(id)},icon," ",e('span',{className:"lbl"},label))
      )
    ),
    e('div',{className:"main fi"},
      tab==="calc"&&e(PayCalc,{onUse:useInBudget}),
      tab==="budget"&&e(BudgetSetup,{incomes,setIncomes,outgoings,setOutgoings}),
      tab==="dashboard"&&e(Dashboard,{incomes,outgoings,statements,setStatements})
    ),
    e('div',{style:{textAlign:"center",padding:"24px",color:"var(--ink4)",fontSize:"11px"}},"apeX CX Â· apexcx.co.uk Â· Tax rates 2024/25")
  );
}

// â”€â”€ PAY CALCULATOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function PayCalc({onUse}){
  const[hm,setHm]=useState("single");
  const[p1,setP1]=useState(emptyP());
  const[p2,setP2]=useState(emptyP());
  const r1=useMemo(()=>calcP(p1),[p1]);
  const r2=useMemo(()=>hm==="dual"?calcP(p2):null,[p2,hm]);
  return e('div',null,
    e('div',{style:{display:"flex",justifyContent:"center",marginBottom:"20px"}},
      e('div',{style:{display:"inline-flex",background:"var(--card)",border:"1px solid var(--border)",borderRadius:"var(--radius-sm)",padding:"4px",gap:"4px"}},
        ...[["single","ðŸ‘¤ Single"],["dual","ðŸ‘¥ Dual Income"]].map(([v,l])=>
          e('button',{key:v,onClick:()=>setHm(v),className:"btn",style:{padding:"8px 20px",background:hm===v?"var(--indigo)":"transparent",color:hm===v?"#fff":"var(--ink3)",border:"none"}},l)
        )
      )
    ),
    e('div',{className:"grid"+(hm==="dual"?" g2":"")},
      e(PersonInput,{p:p1,setP:setP1,label:hm==="dual"?"Person 1":"Your Details",color:"blue"}),
      hm==="dual"&&e(PersonInput,{p:p2,setP:setP2,label:"Person 2",color:"amber"})
    ),
    e('div',{className:"grid"+(hm==="dual"?" g2":""),style:{marginTop:"12px"}},
      e(PersonResult,{r:r1,label:hm==="dual"?"Person 1":"Your Take-Home",color:"blue"}),
      hm==="dual"&&r2&&e(PersonResult,{r:r2,label:"Person 2",color:"amber"})
    ),
    hm==="dual"&&r2&&e('div',{className:"card",style:{background:"var(--green-l)",border:"1px solid var(--green-m)"}},
      e('div',{style:{display:"flex",justifyContent:"space-between",alignItems:"baseline",marginBottom:"12px"}},
        e('span',{style:{fontWeight:"700",fontSize:"15px",color:"var(--green)"}},"Combined Household"),
        e('span',{style:{fontSize:"26px",fontWeight:"700",color:"var(--green)",fontFamily:"DM Mono"}},gbp(r1.net+r2.net))
      ),
      e('div',{className:"grid g3"},
        ...[["Monthly",gbp((r1.net+r2.net)/12)],["Weekly",gbp((r1.net+r2.net)/52)],["Pension",gbp(r1.totalPen+r2.totalPen)]].map(([l,v])=>
          e('div',{key:l},
            e('div',{style:{color:"var(--ink3)",fontSize:"11px",fontWeight:"600",textTransform:"uppercase",letterSpacing:".04em"}},l),
            e('div',{style:{fontWeight:"700",color:"var(--green)",fontSize:"16px"}},v)
          )
        )
      )
    ),
    e('button',{onClick:()=>onUse(r1.netM,hm==="dual"&&r2?r2.netM:null),className:"btn btn-primary btn-lg btn-block",style:{marginTop:"16px"}},"â†’ Use this income in my budget")
  );
}

function PersonInput({p,setP,label,color}){
  const ch=f=>ev=>setP(prev=>({...prev,[f]:ev.target.value}));
  const accent=color==="amber"?"var(--amber)":"var(--indigo)";
  const pFields=[["grossSalary","Base Annual Salary"],["bonus","Annual Bonus"],["carBenefit","Car Benefit"],["medicalBenefit","Medical Benefit"],["otherBenefits","Other Benefits"],["childcare","Childcare Vouchers"],["cyclescheme","Cycle Scheme"]];
  const nFields=[["pensionPercent","Your Pension %"],["employerPensionPercent","Employer Pension %"]];
  return e('div',{className:"card"},
    e('div',{style:{display:"flex",alignItems:"center",gap:"8px",marginBottom:"16px"}},
      e('div',{style:{width:"4px",height:"20px",background:accent,borderRadius:"2px"}}),
      e('h3',{style:{fontSize:"15px",fontWeight:"700"}},label)
    ),
    e('div',{className:"grid g2"},
      ...pFields.map(([f,lbl])=>e('div',{key:f,className:"field"},
        e('label',null,lbl),
        e('div',{className:"input-wrap"},e('span',{className:"pfx"},"Â£"),e('input',{className:"input",type:"number",value:p[f]||"",onChange:ch(f),placeholder:"0"}))
      )),
      ...nFields.map(([f,lbl])=>e('div',{key:f,className:"field"},
        e('label',null,lbl),
        e('input',{className:"input",type:"number",value:p[f]||"",onChange:ch(f),placeholder:"0"})
      ))
    ),
    e('div',{className:"field"},
      e('label',null,"Student Loan"),
      e('select',{className:"select",value:p.studentLoan,onChange:ch("studentLoan")},
        e('option',{value:"none"},"None"),
        ...Object.keys(SL).map(k=>e('option',{key:k,value:k},k==="postgrad"?"Postgrad":"Plan "+k.replace("plan","")))
      )
    )
  );
}

function PersonResult({r,label,color}){
  const accent=color==="amber"?"var(--amber)":"var(--indigo)";
  const bgA=color==="amber"?"var(--amber-l)":"var(--indigo-l)";
  const brA=color==="amber"?"var(--amber-m)":"var(--indigo-m)";
  const rows=[["Gross Salary",gbp(r.gross),false],r.pen>0&&["Your Pension","-"+gbp(r.pen),true],r.ePen>0&&["Employer Pension","+"+gbp(r.ePen),false,"green"],["Income Tax","-"+gbp(r.tax),true],["National Insurance","-"+gbp(r.ni),true],r.sl>0&&["Student Loan","-"+gbp(r.sl),true]].filter(Boolean);
  return e('div',{className:"card"},
    e('div',{style:{display:"flex",alignItems:"center",gap:"8px",marginBottom:"14px"}},
      e('div',{style:{width:"4px",height:"20px",background:accent,borderRadius:"2px"}}),
      e('h3',{style:{fontSize:"15px",fontWeight:"700"}},label)
    ),
    ...rows.map(([k,v,neg,spec])=>e('div',{key:k,style:{display:"flex",justifyContent:"space-between",padding:"6px 0",borderBottom:"1px solid #f1f5f9",fontSize:"13px"}},
      e('span',{style:{color:"var(--ink3)"}},k),
      e('span',{style:{fontWeight:"600",color:spec==="green"?"var(--green)":neg?"var(--red)":"var(--ink)"}},v)
    )),
    e('div',{style:{marginTop:"14px",padding:"16px",background:bgA,borderRadius:"var(--radius-sm)",border:"1px solid "+brA}},
      e('div',{style:{display:"flex",justifyContent:"space-between",alignItems:"baseline",marginBottom:"10px"}},
        e('span',{style:{fontWeight:"700",color:accent}},"Take-Home"),
        e('span',{style:{fontSize:"24px",fontWeight:"700",color:accent,fontFamily:"DM Mono"}},gbp(r.net))
      ),
      e('div',{className:"grid g3",style:{fontSize:"12px"}},
        ...[["Monthly",gbp(r.netM)],["Weekly",gbp(r.netW)],["Pension pot",gbp(r.totalPen)]].map(([l,v])=>
          e('div',{key:l},
            e('div',{style:{color:"var(--ink3)",fontSize:"10px",fontWeight:"700",textTransform:"uppercase",letterSpacing:".04em"}},l),
            e('div',{style:{fontWeight:"700",color:accent}},v)
          )
        )
      )
    )
  );
}

// â”€â”€ BUDGET SETUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function BudgetSetup({incomes,setIncomes,outgoings,setOutgoings}){
  const[mode,setMode]=useState("view");
  const[editing,setEditing]=useState(null);
  const totalIn=incomes.reduce((s,i)=>s+(parseFloat(i.amount)||0),0);
  const totalOut=outgoings.reduce((s,o)=>s+(o.monthlyAmount||0),0);

  if(mode==="incWiz")return e(IncomeWizard,{
    onComplete:d=>{editing?setIncomes(p=>p.map(x=>x.id===editing?{...d,id:editing}:x)):setIncomes(p=>[...p,{...d,id:Date.now()}]);setEditing(null);setMode("view");},
    onCancel:()=>{setEditing(null);setMode("view");},
    initial:editing?incomes.find(i=>i.id===editing):null
  });
  if(mode==="outWiz")return e(OutgoingWizard,{
    onComplete:d=>{editing?setOutgoings(p=>p.map(x=>x.id===editing?{...d,id:editing}:x)):setOutgoings(p=>[...p,{...d,id:Date.now()}]);setEditing(null);setMode("view");},
    onCancel:()=>{setEditing(null);setMode("view");},
    initial:editing?outgoings.find(o=>o.id===editing):null
  });

  return e('div',null,
    e('div',{className:"card"},
      e('div',{className:"section-hdr"},e('h3',null,"ðŸ’° Income Sources"),e('button',{className:"btn btn-primary btn-sm",onClick:()=>setMode("incWiz")},"+ Add Income")),
      incomes.length===0
        ? e('div',{style:{textAlign:"center",padding:"32px",color:"var(--ink4)"}},e('div',{style:{fontSize:"32px",marginBottom:"8px"}},"ðŸ’°"),e('p',null,"No income yet â€” use the Pay Calculator or add manually"))
        : e('div',null,
            e('table',{className:"data-table",style:{width:"100%"}},
              e('thead',null,e('tr',null,e('th',null,"Name"),e('th',null,"Category"),e('th',null,"Pay Date"),e('th',{style:{textAlign:"right"}},"Monthly"),e('th',null))),
              e('tbody',null,...incomes.map(i=>{
                const warn=dateWarning(resDate(i.dateRule,new Date().getFullYear(),new Date().getMonth()));
                return e('tr',{key:i.id},
                  e('td',null,e('span',{style:{fontWeight:"600"}},i.name)),
                  e('td',null,e('span',{className:"tag tag-blue"},i.category)),
                  e('td',null,e('span',{style:{fontSize:"12px"}},i.dateRule==="last"?"Last WD":i.dateRule==="first"?"First WD":i.dateRule+"th"),warn&&e('span',{className:"tag tag-amber",style:{marginLeft:"6px"}},"âš  "+warn)),
                  e('td',{style:{textAlign:"right",fontWeight:"700",color:"var(--green)",fontFamily:"DM Mono"}},gbp(i.amount)),
                  e('td',{style:{textAlign:"right"}},
                    e('button',{className:"btn-ghost",onClick:()=>{setEditing(i.id);setMode("incWiz");}},"âœï¸"),
                    e('button',{className:"btn-danger",style:{marginLeft:"4px"},onClick:()=>setIncomes(p=>p.filter(x=>x.id!==i.id))},"âœ•")
                  )
                );
              }))
            ),
            e('div',{style:{display:"flex",justifyContent:"space-between",padding:"10px 12px",background:"var(--green-l)",borderRadius:"var(--radius-sm)",marginTop:"12px",fontWeight:"700",color:"var(--green)"}},
              e('span',null,"Total Monthly Income"),e('span',{className:"mono"},gbp(totalIn))
            )
          )
    ),
    e('div',{className:"card"},
      e('div',{className:"section-hdr"},e('h3',null,"ðŸ’¸ Outgoings"),e('button',{className:"btn btn-amber btn-sm",onClick:()=>setMode("outWiz")},"+ Add Outgoing")),
      outgoings.length===0
        ? e('div',{style:{textAlign:"center",padding:"32px",color:"var(--ink4)"}},e('div',{style:{fontSize:"32px",marginBottom:"8px"}},"ðŸ“"),e('p',null,"No outgoings yet"))
        : e('div',null,
            ...CATS.map(cat=>{
              const items=outgoings.filter(o=>o.category===cat);
              if(!items.length)return null;
              const catTotal=items.reduce((s,o)=>s+(o.monthlyAmount||0),0);
              return e('div',{key:cat,style:{marginBottom:"16px"}},
                e('div',{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"6px"}},
                  e('span',{style:{fontSize:"11px",fontWeight:"700",color:"var(--ink3)",textTransform:"uppercase",letterSpacing:".05em",display:"flex",alignItems:"center",gap:"6px"}},
                    e('span',{style:{display:"inline-block",width:"8px",height:"8px",borderRadius:"50%",background:CAT_COLORS[cat]||"var(--ink3)"}}),cat
                  ),
                  e('span',{style:{fontSize:"12px",fontWeight:"600",color:"var(--ink3)",fontFamily:"DM Mono"}},gbp(catTotal)+"/mo")
                ),
                e('table',{className:"data-table",style:{width:"100%"}},
                  e('tbody',null,...items.map(o=>{
                    const warn=dateWarning(resDate(o.dateRule==="custom"?o.customDay:o.dateRule,new Date().getFullYear(),new Date().getMonth()));
                    return e('tr',{key:o.id},
                      e('td',null,e('span',{style:{fontWeight:"600"}},o.name)),
                      e('td',null,e('span',{className:"tag tag-gray"},o.account)),
                      e('td',{style:{fontSize:"12px"}},o.dateRule==="last"?"Last WD":o.dateRule==="first"?"First WD":o.dateRule==="custom"?o.customDay+"th":o.dateRule+"th",warn&&e('span',{className:"tag tag-amber",style:{marginLeft:"6px"}},"âš  "+warn)),
                      e('td',{style:{textAlign:"right",fontWeight:"700",color:"var(--red)",fontFamily:"DM Mono"}},gbp(o.monthlyAmount)),
                      e('td',{style:{textAlign:"right"}},
                        e('button',{className:"btn-ghost",onClick:()=>{setEditing(o.id);setMode("outWiz");}},"âœï¸"),
                        e('button',{className:"btn-danger",style:{marginLeft:"4px"},onClick:()=>setOutgoings(p=>p.filter(x=>x.id!==o.id))},"âœ•")
                      )
                    );
                  }))
                )
              );
            }),
            e('div',{style:{display:"flex",justifyContent:"space-between",padding:"10px 12px",background:"var(--red-l)",borderRadius:"var(--radius-sm)",marginTop:"8px",fontWeight:"700",color:"var(--red)"}},
              e('span',null,"Total Monthly Outgoings"),e('span',{className:"mono"},gbp(totalOut))
            )
          )
    )
  );
}

// â”€â”€ INCOME WIZARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function IncomeWizard({onComplete,onCancel,initial}){
  const[step,setStep]=useState(0);
  const[d,setD]=useState(initial||{name:"",amount:"",isNet:true,category:"Salary",dateRule:"last",customDay:""});
  const set=(k,v)=>setD(p=>({...p,[k]:v}));
  const steps=5;
  const ok=[()=>!!d.name,()=>!!d.amount,()=>!!d.category,()=>d.dateRule==="custom"?!!d.customDay:!!d.dateRule,()=>true];
  let body=null;
  if(step===0)body=e('div',null,e('div',{className:"wlabel"},"Step 1 â€” Name"),e('div',{className:"wtitle"},"What is this income?"),e('div',{className:"field"},e('label',null,"Label"),e('input',{className:"input",value:d.name,onChange:ev=>set("name",ev.target.value),placeholder:"e.g. Monthly Salary"})));
  if(step===1)body=e('div',null,
    e('div',{className:"wlabel"},"Step 2 â€” Amount"),e('div',{className:"wtitle"},"How much do you receive?"),
    e('div',{style:{display:"flex",gap:"8px",marginBottom:"12px"}},
      e('button',{onClick:()=>set("isNet",true),className:"cbtn"+(d.isNet===true?" sel-b":""),style:{flex:1,textAlign:"center"}},"Net (take-home)"),
      e('button',{onClick:()=>set("isNet",false),className:"cbtn"+(d.isNet===false?" sel-b":""),style:{flex:1,textAlign:"center"}},"Gross (before tax)")
    ),
    e('div',{className:"field"},e('label',null,"Monthly Amount (Â£)"),e('div',{className:"input-wrap"},e('span',{className:"pfx"},"Â£"),e('input',{className:"input",type:"number",value:d.amount,onChange:ev=>set("amount",ev.target.value),placeholder:"2500"}))),
    d.amount&&e('div',{style:{display:"flex",gap:"8px",marginTop:"8px"}},
      ...[["Annual",gbp((parseFloat(d.amount)||0)*12)],["Weekly",gbp((parseFloat(d.amount)||0)*12/52)]].map(([l,v])=>
        e('div',{key:l,style:{flex:1,background:"var(--paper)",borderRadius:"var(--radius-sm)",padding:"10px",textAlign:"center"}},
          e('div',{style:{fontSize:"10px",color:"var(--ink4)",fontWeight:"700",textTransform:"uppercase",letterSpacing:".04em"}},l),
          e('div',{style:{fontWeight:"700",color:"var(--indigo)",fontFamily:"DM Mono"}},v)
        )
      )
    )
  );
  if(step===2)body=e('div',null,e('div',{className:"wlabel"},"Step 3 â€” Category"),e('div',{className:"wtitle"},"What type of income?"),e('div',{className:"choice-grid g2"},...INC_CATS.map(c=>e('button',{key:c,onClick:()=>set("category",c),className:"cbtn"+(d.category===c?" sel-b":"")},c))));
  if(step===3)body=e('div',null,
    e('div',{className:"wlabel"},"Step 4 â€” Pay Date"),e('div',{className:"wtitle"},"When do you get paid?"),
    e('div',{className:"choice-grid"},...[["last","Last working day"],["first","First working day"],["25","25th"],["28","28th"],["15","15th"],["custom","Specific day"]].map(([v,l])=>e('button',{key:v,onClick:()=>set("dateRule",v),className:"cbtn"+(d.dateRule===v?" sel-b":"")},l))),
    d.dateRule==="custom"&&e('div',{className:"field",style:{marginTop:"12px"}},e('label',null,"Day of month"),e('input',{className:"input",type:"number",min:1,max:28,value:d.customDay,onChange:ev=>set("customDay",ev.target.value),placeholder:"20"}))
  );
  if(step===4)body=e('div',null,
    e('div',{className:"wlabel"},"Confirm"),e('div',{className:"wtitle"},"Does this look right?"),
    e('div',{style:{background:"var(--paper)",borderRadius:"var(--radius-sm)",padding:"16px"}},
      ...[["Name",d.name],["Monthly",gbp(d.amount)],["Annual",gbp((parseFloat(d.amount)||0)*12)],["Category",d.category],["Type",d.isNet?"Net":"Gross"],["Pay Date",d.dateRule==="last"?"Last working day":d.dateRule==="first"?"First working day":d.dateRule==="custom"?(d.customDay+"th"):(d.dateRule+"th")]].map(([k,v])=>
        e('div',{key:k,style:{display:"flex",justifyContent:"space-between",padding:"7px 0",borderBottom:"1px solid var(--border)",fontSize:"13px"}},e('span',{style:{color:"var(--ink3)"}},k),e('span',{style:{fontWeight:"600"}},v))
      )
    )
  );
  return e('div',{className:"wizard-wrap card fi"},
    e('div',{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"20px"}},
      e('h2',{style:{fontSize:"18px",fontWeight:"700"}},"ðŸ’° "+(initial?"Edit":"Add")+" Income"),
      e('span',{style:{fontSize:"12px",color:"var(--ink4)"}},(step+1)+"/"+steps)
    ),
    e('div',{className:"wpips"},...Array.from({length:steps},(_,i)=>e('div',{key:i,className:"wpip"+(i<=step?" done":"")}))),
    body,
    e('div',{className:"wnav"},
      e('button',{onClick:step===0?onCancel:()=>setStep(s=>s-1),className:"btn btn-outline"},step===0?"âœ• Cancel":"â† Back"),
      e('button',{onClick:()=>step<steps-1?setStep(s=>s+1):onComplete(d),disabled:!ok[step](),className:"btn btn-primary",style:{flex:1}},step===steps-1?"âœ“ Save Income":"Next â†’")
    )
  );
}

// â”€â”€ OUTGOING WIZARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function OutgoingWizard({onComplete,onCancel,initial}){
  const[step,setStep]=useState(0);
  const[d,setD]=useState(initial||{name:"",category:"",amount:"",frequency:"monthly",dateRule:"1",customDay:"",account:"Starling"});
  const set=(k,v)=>setD(p=>({...p,[k]:v}));
  const steps=6;
  const monthly=d.frequency==="annual"?(parseFloat(d.amount)||0)/12:(parseFloat(d.amount)||0);
  const ok=[()=>!!d.category,()=>!!d.amount,()=>d.dateRule==="custom"?!!d.customDay:!!d.dateRule,()=>!!d.account,()=>!!d.name,()=>true];
  let body=null;
  if(step===0)body=e('div',null,e('div',{className:"wlabel"},"Step 1 â€” Category"),e('div',{className:"wtitle"},"What type of outgoing?"),e('div',{className:"choice-grid g3"},...CATS.map(c=>e('button',{key:c,onClick:()=>set("category",c),className:"cbtn"+(d.category===c?" sel-a":""),style:{fontSize:"12px",padding:"10px 8px",display:"flex",alignItems:"center",gap:"6px"}},e('span',{style:{display:"inline-block",width:"8px",height:"8px",borderRadius:"50%",background:CAT_COLORS[c]||"var(--ink4)",flexShrink:0}}),c))));
  if(step===1)body=e('div',null,
    e('div',{className:"wlabel"},"Step 2 â€” Amount"),e('div',{className:"wtitle"},"How much is it?"),
    e('div',{style:{display:"flex",gap:"8px",marginBottom:"12px"}},
      e('button',{onClick:()=>set("frequency","monthly"),className:"cbtn"+(d.frequency==="monthly"?" sel-a":""),style:{flex:1,textAlign:"center"}},"Monthly"),
      e('button',{onClick:()=>set("frequency","annual"),className:"cbtn"+(d.frequency==="annual"?" sel-a":""),style:{flex:1,textAlign:"center"}},"Annual (will convert)")
    ),
    e('div',{className:"field"},e('label',null,"Amount (Â£)"),e('div',{className:"input-wrap"},e('span',{className:"pfx"},"Â£"),e('input',{className:"input",type:"number",value:d.amount,onChange:ev=>set("amount",ev.target.value),placeholder:"100"}))),
    d.frequency==="annual"&&d.amount&&e('div',{className:"alert alert-warn"},"Annual ",e('strong',null,gbp(d.amount))," â†’ ",e('strong',null,gbp(monthly)+"/month"))
  );
  if(step===2)body=e('div',null,
    e('div',{className:"wlabel"},"Step 3 â€” Date"),e('div',{className:"wtitle"},"When is this paid?"),
    e('div',{className:"choice-grid"},...[["1","1st"],["last","Last working day"],["first","First working day"],["15","15th"],["28","28th"],["custom","Specific day"]].map(([v,l])=>e('button',{key:v,onClick:()=>set("dateRule",v),className:"cbtn"+(d.dateRule===v?" sel-a":"")},l))),
    d.dateRule==="custom"&&e('div',{className:"field",style:{marginTop:"12px"}},e('label',null,"Day of month"),e('input',{className:"input",type:"number",min:1,max:28,value:d.customDay,onChange:ev=>set("customDay",ev.target.value),placeholder:"20"}))
  );
  if(step===3)body=e('div',null,e('div',{className:"wlabel"},"Step 4 â€” Account"),e('div',{className:"wtitle"},"Which account?"),e('div',{className:"choice-grid"},...ACCOUNTS.map(a=>e('button',{key:a,onClick:()=>set("account",a),className:"cbtn"+(d.account===a?" sel-a":"")},a))));
  if(step===4)body=e('div',null,e('div',{className:"wlabel"},"Step 5 â€” Name"),e('div',{className:"wtitle"},"What's the payee?"),e('div',{className:"field"},e('label',null,"Name"),e('input',{className:"input",value:d.name,onChange:ev=>set("name",ev.target.value),placeholder:"e.g. Rent, Netflix"})));
  if(step===5)body=e('div',null,
    e('div',{className:"wlabel"},"Confirm"),e('div',{className:"wtitle"},"Does this look right?"),
    e('div',{style:{background:"var(--paper)",borderRadius:"var(--radius-sm)",padding:"16px"}},
      ...[["Name",d.name],["Category",d.category],["Monthly",gbp(monthly)],d.frequency==="annual"?["Annual",gbp(d.amount)]:null,["Account",d.account],["Date",d.dateRule==="custom"?(d.customDay+"th"):d.dateRule==="last"?"Last WD":d.dateRule==="first"?"First WD":(d.dateRule+"th")]].filter(Boolean).map(([k,v])=>
        e('div',{key:k,style:{display:"flex",justifyContent:"space-between",padding:"7px 0",borderBottom:"1px solid var(--border)",fontSize:"13px"}},e('span',{style:{color:"var(--ink3)"}},k),e('span',{style:{fontWeight:"600"}},v))
      )
    )
  );
  return e('div',{className:"wizard-wrap card fi"},
    e('div',{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"20px"}},
      e('h2',{style:{fontSize:"18px",fontWeight:"700"}},"ðŸ’¸ "+(initial?"Edit":"Add")+" Outgoing"),
      e('span',{style:{fontSize:"12px",color:"var(--ink4)"}},(step+1)+"/"+steps)
    ),
    e('div',{className:"wpips"},...Array.from({length:steps},(_,i)=>e('div',{key:i,className:"wpip"+(i<=step?" done-a":"")}))),
    body,
    e('div',{className:"wnav"},
      e('button',{onClick:step===0?onCancel:()=>setStep(s=>s-1),className:"btn btn-outline"},step===0?"âœ• Cancel":"â† Back"),
      e('button',{onClick:()=>step<steps-1?setStep(s=>s+1):onComplete({...d,monthlyAmount:monthly}),disabled:!ok[step](),className:"btn btn-amber",style:{flex:1}},step===steps-1?"âœ“ Save Outgoing":"Next â†’")
    )
  );
}

// â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function Dashboard({incomes,outgoings,statements,setStatements}){
  const[dashTab,setDashTab]=useState("overview");
  const totalIn=incomes.reduce((s,i)=>s+(parseFloat(i.amount)||0),0);
  const totalOut=outgoings.reduce((s,o)=>s+(o.monthlyAmount||0),0);
  const surplus=totalIn-totalOut;
  if(!incomes.length&&!outgoings.length)return e('div',{className:"card",style:{textAlign:"center",padding:"60px 20px"}},e('div',{style:{fontSize:"48px",marginBottom:"12px"}},"ðŸ“Š"),e('h3',{style:{marginBottom:"8px"}},"Nothing to show yet"),e('p',{style:{color:"var(--ink3)"}},"Add your income and outgoings in Budget Setup"));
  const DTABS=[["overview","Overview"],["schedule","Schedule"],["charts","Charts"],["statements","Statements"]];
  return e('div',null,
    e('div',{className:"grid g3",style:{marginBottom:"16px"}},
      e('div',{className:"stat-box stat-green"},e('div',{className:"stat-label"},"Monthly Income"),e('div',{className:"stat-val"},gbp(totalIn)),e('div',{className:"stat-sub"},gbp(totalIn/52)+"/wk Â· "+gbp(totalIn*12)+"/yr")),
      e('div',{className:"stat-box stat-red"},e('div',{className:"stat-label"},"Monthly Outgoings"),e('div',{className:"stat-val"},gbp(totalOut)),e('div',{className:"stat-sub"},gbp(totalOut/52)+"/wk Â· "+gbp(totalOut*12)+"/yr")),
      e('div',{className:"stat-box "+(surplus>=0?"stat-blue":"stat-red")},e('div',{className:"stat-label"},surplus>=0?"Surplus":"Deficit"),e('div',{className:"stat-val"},gbp(Math.abs(surplus))),e('div',{className:"stat-sub"},surplus>=0?"Available to save/spend":"You're overspending"))
    ),
    e('div',{style:{display:"flex",background:"var(--card)",border:"1px solid var(--border)",borderRadius:"var(--radius-sm)",padding:"4px",gap:"4px",marginBottom:"16px"}},
      ...DTABS.map(([id,label])=>e('button',{key:id,onClick:()=>setDashTab(id),className:"btn",style:{flex:1,background:dashTab===id?"var(--indigo)":"transparent",color:dashTab===id?"#fff":"var(--ink3)",border:"none",padding:"8px 12px",fontSize:"13px"}},label))
    ),
    dashTab==="overview"&&e(DashOverview,{incomes,outgoings,totalIn,totalOut,surplus}),
    dashTab==="schedule"&&e(DashSchedule,{incomes,outgoings}),
    dashTab==="charts"&&e(DashCharts,{incomes,outgoings,totalIn,totalOut}),
    dashTab==="statements"&&e(DashStatements,{outgoings,statements,setStatements})
  );
}

function DashOverview({incomes,outgoings,totalIn,totalOut,surplus}){
  const catTotals=CATS.map(c=>({cat:c,amount:outgoings.filter(o=>o.category===c).reduce((s,o)=>s+(o.monthlyAmount||0),0)})).filter(x=>x.amount>0).sort((a,b)=>b.amount-a.amount);
  return e('div',null,
    e('div',{className:"grid g2"},
      e('div',{className:"card"},
        e('div',{className:"card-title"},"ðŸ“ˆ Annual Overview"),
        ...[["Annual Income",gbp(totalIn*12),"var(--green)"],["Annual Outgoings",gbp(totalOut*12),"var(--red)"],["Annual Surplus",gbp(Math.abs(surplus*12)),surplus>=0?"var(--indigo-d)":"var(--red)"]].map(([l,v,c])=>
          e('div',{key:l,style:{display:"flex",justifyContent:"space-between",padding:"8px 0",borderBottom:"1px solid var(--border)",fontSize:"14px"}},e('span',{style:{color:"var(--ink3)"}},l),e('span',{style:{fontWeight:"700",color:c,fontFamily:"DM Mono"}},v))
        ),
        e('div',{style:{marginTop:"14px"}},
          e('div',{style:{fontSize:"11px",fontWeight:"700",color:"var(--ink3)",textTransform:"uppercase",letterSpacing:".04em",marginBottom:"6px"}},"Budget used"),
          e('div',{className:"prog-bar"},e('div',{className:"prog-fill",style:{width:Math.min(100,totalOut/totalIn*100)+"%",background:totalOut/totalIn>0.9?"var(--red)":totalOut/totalIn>0.7?"var(--amber)":"var(--green)"}})),
          e('div',{style:{fontSize:"11px",color:"var(--ink3)",marginTop:"4px"}},Math.round(totalOut/totalIn*100)+"% of income committed")
        )
      ),
      e('div',{className:"card"},
        e('div',{className:"card-title"},"ðŸ’¸ Spending by Category"),
        ...catTotals.slice(0,8).map(({cat,amount})=>e('div',{key:cat,style:{marginBottom:"10px"}},
          e('div',{style:{display:"flex",justifyContent:"space-between",fontSize:"12px",marginBottom:"3px"}},e('span',{style:{color:"var(--ink2)",fontWeight:"500"}},cat),e('span',{style:{fontWeight:"600",fontFamily:"DM Mono"}},gbp(amount))),
          e('div',{className:"prog-bar",style:{height:"6px"}},e('div',{className:"prog-fill",style:{width:(amount/totalOut*100)+"%",background:CAT_COLORS[cat]||"var(--ink3)"}}))
        ))
      )
    ),
    surplus<0&&e('div',{className:"alert alert-danger",style:{marginTop:"12px"}},"âš ï¸ You're spending ",e('strong',null,gbp(Math.abs(surplus)))," more than you earn each month."),
    surplus>0&&surplus<totalIn*0.1&&e('div',{className:"alert alert-warn",style:{marginTop:"12px"}},"âš ï¸ Your surplus is less than 10% of income.")
  );
}

function DashSchedule({incomes,outgoings}){
  const now=new Date();
  const totalIn=incomes.reduce((s,i)=>s+(parseFloat(i.amount)||0),0);
  const totalOut=outgoings.reduce((s,o)=>s+(o.monthlyAmount||0),0);
  const months=Array.from({length:3},(_,i)=>{const d=new Date(now.getFullYear(),now.getMonth()+i,1);return{y:d.getFullYear(),m:d.getMonth(),label:d.toLocaleDateString("en-GB",{month:"long",year:"numeric"})};});
  return e('div',null,...months.map(({y,m,label})=>{
    const events=[];
    incomes.forEach(inc=>{const d=resDate(inc.dateRule,y,m);if(d)events.push({date:d,label:inc.name,amount:parseFloat(inc.amount)||0,type:"inc"});});
    outgoings.forEach(out=>{const d=resDate(out.dateRule==="custom"?out.customDay:out.dateRule,y,m);if(d)events.push({date:d,label:out.name,amount:out.monthlyAmount||0,type:"out",account:out.account});});
    events.sort((a,b)=>a.date-b.date);
    const starlingOut=outgoings.filter(o=>o.account==="Starling").reduce((s,o)=>s+(o.monthlyAmount||0),0);
    const nationwideOut=outgoings.filter(o=>o.account==="Nationwide").reduce((s,o)=>s+(o.monthlyAmount||0),0);
    const lastInc=[...events].filter(ev=>ev.type==="inc").pop();
    const firstOut=events.find(ev=>ev.type==="out");
    const firstInc=events.find(ev=>ev.type==="inc");
    const bufferGap=firstInc&&firstOut&&firstOut.date<firstInc.date;
    return e('div',{key:label,className:"month-card"},
      e('div',{className:"month-hdr"},e('span',null,label),e('div',{style:{display:"flex",gap:"8px",fontSize:"12px"}},e('span',{style:{color:"var(--green)",fontWeight:"600",fontFamily:"DM Mono"}},"+"+gbp(totalIn)),e('span',{style:{color:"var(--red)",fontWeight:"600",fontFamily:"DM Mono"}},"-"+gbp(totalOut)))),
      e('div',{className:"month-body"},
        bufferGap&&e('div',{className:"alert alert-danger"},"âš ï¸ Outgoing on "+fmtD(firstOut.date)+" before income on "+fmtD(firstInc.date)+" â€” ensure a buffer!"),
        lastInc&&starlingOut>0&&e('div',{className:"alert alert-info"},"ðŸ’¸ Transfer ",e('strong',null,gbp(starlingOut))," to Starling on ",e('strong',null,fmtD(lastInc.date))," when salary lands"),
        lastInc&&nationwideOut>0&&e('div',{className:"alert alert-info"},"ðŸ¦ Transfer ",e('strong',null,gbp(nationwideOut))," to Nationwide on ",e('strong',null,fmtD(lastInc.date))," when salary lands"),
        ...events.map((ev,i)=>e('div',{key:i,className:"event-row event-"+ev.type},
          e('div',{style:{display:"flex",alignItems:"center",gap:"10px"}},
            e('span',{style:{color:"var(--ink3)",minWidth:"60px",fontSize:"12px",fontFamily:"DM Mono"}},fmtD(ev.date)),
            e('span',{style:{fontWeight:"500"}},ev.label),
            ev.account&&e('span',{className:"tag tag-gray"},ev.account)
          ),
          e('span',{className:"eamt"},(ev.type==="inc"?"+":"-")+gbp(ev.amount))
        ))
      )
    );
  }));
}

function DashCharts({incomes,outgoings,totalIn,totalOut}){
  const catData=CATS.map(c=>({name:c,value:Math.round(outgoings.filter(o=>o.category===c).reduce((s,o)=>s+(o.monthlyAmount||0),0)),color:CAT_COLORS[c]||"#94a3b8"})).filter(x=>x.value>0);
  const months=Array.from({length:6},(_,i)=>{const d=new Date(new Date().getFullYear(),new Date().getMonth()-5+i,1);return{name:d.toLocaleDateString("en-GB",{month:"short"}),income:Math.round(totalIn),outgoings:Math.round(totalOut),surplus:Math.max(0,Math.round(totalIn-totalOut))};});
  return e('div',null,
    e('div',{className:"grid g2"},
      e('div',{className:"card"},
        e('div',{className:"card-title"},"ðŸ© Spending by Category"),
        e(DonutChart,{data:catData}),
        e('div',{style:{display:"flex",flexWrap:"wrap",gap:"6px",marginTop:"12px"}},
          ...catData.map(c=>e('div',{key:c.name,style:{display:"flex",alignItems:"center",gap:"4px",fontSize:"11px",color:"var(--ink3)"}},e('span',{style:{display:"inline-block",width:"8px",height:"8px",borderRadius:"50%",background:c.color}}),c.name))
        )
      ),
      e('div',{className:"card"},e('div',{className:"card-title"},"ðŸ“Š Income vs Outgoings"),e(BarChartSVG,{data:months}))
    ),
    e('div',{className:"card",style:{marginTop:"12px"}},
      e('div',{className:"card-title"},"ðŸ“… Annual Cost Breakdown"),
      e('div',{className:"grid g4"},
        ...[["Annual income",gbp(totalIn*12),"var(--green)"],["Annual outgoings",gbp(totalOut*12),"var(--red)"],["Annual surplus",gbp(Math.abs((totalIn-totalOut)*12)),(totalIn-totalOut)>=0?"var(--indigo-d)":"var(--red)"],["Saving rate",Math.round((totalIn-totalOut)/totalIn*100)+"%",(totalIn-totalOut)>=0?"var(--green)":"var(--red)"]].map(([l,v,c])=>
          e('div',{key:l,style:{background:"var(--paper)",borderRadius:"var(--radius-sm)",padding:"14px",textAlign:"center"}},
            e('div',{style:{fontSize:"10px",fontWeight:"700",textTransform:"uppercase",letterSpacing:".04em",color:"var(--ink4)",marginBottom:"6px"}},l),
            e('div',{style:{fontSize:"18px",fontWeight:"700",color:c,fontFamily:"DM Mono"}},v)
          )
        )
      )
    )
  );
}

function DashStatements({outgoings,statements,setStatements}){
  const[dragging,setDragging]=useState(false);
  const[processing,setProcessing]=useState(false);
  const[activeStmt,setActiveStmt]=useState(statements.length>0?statements[statements.length-1].id:null);
  const fileRef=useRef();
  const processFile=async file=>{
    setProcessing(true);
    try{
      const text=await file.text();
      const isNW=text.toLowerCase().includes("nationwide")||file.name.toLowerCase().includes("nationwide");
      const rows=isNW?parseNationwideCSV(text):parseStarlingCSV(text);
      const transactions=rows.map((r,i)=>({id:i,date:r.date,description:r.description,amount:r.amount,category:guessCat(r.description),confirmed:false}));
      const stmt={id:Date.now(),name:file.name,bank:isNW?"Nationwide":"Starling",uploadDate:new Date().toISOString(),transactions};
      setStatements(p=>[...p,stmt]);setActiveStmt(stmt.id);
    }catch(err){alert("Could not parse file.");}
    setProcessing(false);
  };
  const stmt=statements.find(s=>s.id===activeStmt);
  const updateCat=(sId,tId,cat)=>setStatements(p=>p.map(s=>s.id!==sId?s:{...s,transactions:s.transactions.map(t=>t.id!==tId?t:{...t,category:cat,confirmed:true})}));
  const removeStmt=id=>{setStatements(p=>p.filter(s=>s.id!==id));if(activeStmt===id)setActiveStmt(null);};
  const budgetByCat=CATS.reduce((acc,c)=>{acc[c]=outgoings.filter(o=>o.category===c).reduce((s,o)=>s+(o.monthlyAmount||0),0);return acc;},{});
  const actualByCat=stmt?CATS.reduce((acc,c)=>{acc[c]=stmt.transactions.filter(t=>t.category===c).reduce((s,t)=>s+t.amount,0);return acc;},{}):null;
  const catsWithData=CATS.filter(c=>(budgetByCat[c]||0)+((actualByCat&&actualByCat[c])||0)>0);
  return e('div',null,
    e('div',{className:"card"},
      e('div',{className:"card-title"},"ðŸ“ Upload Bank Statement"),
      e('div',{className:"upload-zone"+(dragging?" drag":""),onDragOver:ev=>{ev.preventDefault();setDragging(true);},onDragLeave:()=>setDragging(false),onDrop:ev=>{ev.preventDefault();setDragging(false);const f=ev.dataTransfer.files[0];if(f)processFile(f);},onClick:()=>fileRef.current&&fileRef.current.click()},
        e('div',{style:{fontSize:"32px"}},processing?"â³":"ðŸ“‚"),
        e('p',{style:{fontWeight:"600",marginTop:"8px"}},processing?"Processingâ€¦":"Drop CSV here or click to browse"),
        e('p',null,"Supports Starling and Nationwide CSV exports"),
        e('input',{ref:fileRef,type:"file",accept:".csv",style:{display:"none"},onChange:ev=>{const f=ev.target.files[0];if(f)processFile(f);}})
      ),
      statements.length>0&&e('div',{style:{marginTop:"12px"}},
        e('div',{style:{fontSize:"11px",fontWeight:"700",textTransform:"uppercase",color:"var(--ink4)",marginBottom:"8px"}},"Uploaded Statements"),
        e('div',{style:{display:"flex",flexWrap:"wrap",gap:"6px"}},
          ...statements.map(s=>e('div',{key:s.id,style:{display:"flex",alignItems:"center",gap:"6px",padding:"6px 12px",borderRadius:"var(--radius-sm)",border:"1.5px solid "+(activeStmt===s.id?"var(--indigo)":"var(--border)"),background:activeStmt===s.id?"var(--indigo-l)":"var(--card)",cursor:"pointer"},onClick:()=>setActiveStmt(s.id)},
            e('span',{style:{fontSize:"12px",fontWeight:"600",color:activeStmt===s.id?"var(--indigo-d)":"var(--ink2)"}},s.bank+" Â· "+new Date(s.uploadDate).toLocaleDateString("en-GB",{day:"numeric",month:"short"})),
            e('button',{onClick:ev=>{ev.stopPropagation();removeStmt(s.id);},style:{background:"none",border:"none",color:"var(--ink4)",cursor:"pointer",fontSize:"12px"}},"âœ•")
          ))
        )
      )
    ),
    stmt&&actualByCat&&e('div',null,
      e('div',{className:"card"},
        e('div',{className:"card-title"},"âš–ï¸ Budget vs Actual â€” "+stmt.bank),
        e('table',{className:"data-table",style:{width:"100%"}},
          e('thead',null,e('tr',null,e('th',null,"Category"),e('th',{style:{textAlign:"right"}},"Budget"),e('th',{style:{textAlign:"right"}},"Actual"),e('th',{style:{textAlign:"right"}},"Diff"),e('th',null))),
          e('tbody',null,...catsWithData.map(c=>{
            const budget=budgetByCat[c]||0,actual=actualByCat[c]||0,diff=budget-actual;
            return e('tr',{key:c},
              e('td',null,e('span',{style:{display:"inline-flex",alignItems:"center",gap:"6px"}},e('span',{style:{width:"8px",height:"8px",borderRadius:"50%",background:CAT_COLORS[c],display:"inline-block"}}),c)),
              e('td',{style:{textAlign:"right",fontFamily:"DM Mono",fontSize:"12px"}},gbp(budget)),
              e('td',{style:{textAlign:"right",fontFamily:"DM Mono",fontSize:"12px"}},gbp(actual)),
              e('td',{style:{textAlign:"right",fontFamily:"DM Mono",fontSize:"12px",fontWeight:"700",color:diff>=0?"var(--green)":"var(--red)"}},( diff>=0?"+":"")+gbp(diff)),
              e('td',null,e('div',{className:"prog-bar",style:{width:"60px",display:"inline-block"}},e('div',{className:"prog-fill",style:{width:Math.min(100,(actual/Math.max(budget,actual,1))*100)+"%",background:actual>budget?"var(--red)":"var(--green)"}})))
            );
          }))
        )
      ),
      e('div',{className:"card"},
        e('div',{className:"section-hdr"},e('h3',null,"ðŸ§¾ Transactions ("+stmt.transactions.length+")"),e('span',{style:{fontSize:"12px",color:"var(--ink3)"}},stmt.bank+" export")),
        e('table',{className:"data-table",style:{width:"100%"}},
          e('thead',null,e('tr',null,e('th',null,"Date"),e('th',null,"Description"),e('th',null,"Category"),e('th',{style:{textAlign:"right"}},"Amount"))),
          e('tbody',null,...stmt.transactions.map(t=>e('tr',{key:t.id},
            e('td',{style:{fontFamily:"DM Mono",fontSize:"12px",whiteSpace:"nowrap"}},t.date),
            e('td',{style:{maxWidth:"240px",fontSize:"13px"}},t.description),
            e('td',null,e('select',{className:"select",value:t.category,onChange:ev=>updateCat(stmt.id,t.id,ev.target.value),style:{padding:"4px 8px",fontSize:"11px",width:"auto",minWidth:"120px"}},
              ...CATS.map(c=>e('option',{key:c,value:c},c))
            )),
            e('td',{style:{textAlign:"right",fontFamily:"DM Mono",fontSize:"12px",fontWeight:"700",color:"var(--red)"}},gbp(t.amount))
          )))
        )
      )
    )
  );
}

// â”€â”€ MOUNT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ReactDOM.createRoot(document.getElementById('root')).render(e(App));
</script>
</body>
</html>
